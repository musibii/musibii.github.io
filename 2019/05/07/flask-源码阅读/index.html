<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>flask 源码阅读 | rsuxwvilc</title><meta name="author" content="vilc"><meta name="copyright" content="vilc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="启动 py 文件 导入 request 或 session  1from flask import request    执行 flask 文件，生成 request对象，这是个全局的request对象，请求来的数据，元数据都在这个request里面。   生成 request 对象其实是LocalProxy类的实例  123request &#x3D; LocalProxy(partial(_lookup">
<meta property="og:type" content="article">
<meta property="og:title" content="flask 源码阅读">
<meta property="og:url" content="https://rsuxwvilc.github.io/2019/05/07/flask-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/index.html">
<meta property="og:site_name" content="rsuxwvilc">
<meta property="og:description" content="启动 py 文件 导入 request 或 session  1from flask import request    执行 flask 文件，生成 request对象，这是个全局的request对象，请求来的数据，元数据都在这个request里面。   生成 request 对象其实是LocalProxy类的实例  123request &#x3D; LocalProxy(partial(_lookup">
<meta property="og:locale">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2019-05-07T08:38:59.000Z">
<meta property="article:modified_time" content="2019-10-18T06:23:43.000Z">
<meta property="article:author" content="vilc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://rsuxwvilc.github.io/2019/05/07/flask-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'flask 源码阅读',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-10-18 14:23:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">141</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">rsuxwvilc</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">flask 源码阅读<a class="post-edit-link" href="https://github.com/rsuxwvilc/rsuxwvilc.github.io/tree/master_posts/flask-源码阅读.md" title="Edited on" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2019-05-07T08:38:59.000Z" title="Created 2019-05-07 16:38:59">2019-05-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-10-18T06:23:43.000Z" title="Updated 2019-10-18 14:23:43">2019-10-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/flask/">flask</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">2.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>14min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="flask 源码阅读"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="启动-py-文件"><a href="#启动-py-文件" class="headerlink" title="启动 py 文件"></a>启动 py 文件</h1><ol>
<li>导入 request 或 session</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request </span><br></pre></td></tr></table></figure>


<p>执行 flask 文件，生成 <code>request</code>对象，这是个全局的<code>request</code>对象，请求来的数据，元数据都在这个<code>request</code>里面。 </p>
<ol start="2">
<li>生成 request 对象其实是<code>LocalProxy</code>类的实例</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">&#x27;request&#x27;</span>)) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行 init方法</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, local, name=<span class="literal">None</span></span>): </span><br><span class="line"></span><br><span class="line"><span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;_LocalProxy__local&#x27;</span>, local) </span><br><span class="line"></span><br><span class="line"><span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__name__&#x27;</span>, name) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">callable</span>(local) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(local, <span class="string">&#x27;__release_local__&#x27;</span>): </span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;local&quot; is a callable that is not an instance of Local or </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LocalManager: mark it as a wrapped function. </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;__wrapped__&#x27;</span>, local) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中<code>partial(_lookup_req_obj, &#39;request)</code>当做参数传给<code>init</code>里面的<code>local</code>变量。 </p>
<p><strong>partial 函数</strong>：偏函数，当我们要执行一个函数时，会遇到参数不齐，选择偏函数先将部分参数传进去，经过偏函数会生成一个<code>functools.partial</code>对象，是要执行函数的内存地址，不过参数已经传进去了。 </p>
<ol start="4">
<li>执行<code>__setattr__</code>设值。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">object</span>.__setattr__(self, <span class="string">&#x27;_LocalProxy__local&#x27;</span>, local) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为什么不直接使用<code>self._Local__local = local</code>这种设置属性的方法呢？ </p>
<p>第一点是因为，如果使用<code>self</code>设置值的话会调用类的<code>setattr</code>方法，而<code>setattr</code>方法被重写，用来获取当前<code>__local()</code>对象中的属性值了，这样会产生冲突，而这里只需要简单的给<code>self</code>设置一个值，所以采用父类的<code>setattr</code>来设置值，那么为什么不是<code>object.__setattr__(self, &#39;__local&#39;, local)</code>这种方式呢？因为<code>__local</code>是类私有属性，想要使用的话需要按照这个方式来。 </p>
<p>经过这一步，将<code>local</code>，也就是传进来的偏函数内存地址赋值给<code>__local</code>属性了。 </p>
<h1 id="执行-app-run-做的事"><a href="#执行-app-run-做的事" class="headerlink" title="执行 app.run()做的事"></a>执行 app.run()做的事</h1><p>源代码如下： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, host=<span class="literal">None</span>, port=<span class="literal">None</span>, debug=<span class="literal">None</span>, load_dotenv=<span class="literal">True</span>, **options</span>): </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.environ.get(<span class="string">&#x27;FLASK_RUN_FROM_CLI&#x27;</span>) == <span class="string">&#x27;true&#x27;</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .debughelpers <span class="keyword">import</span> explain_ignored_app_run </span><br><span class="line"></span><br><span class="line">explain_ignored_app_run() </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> get_load_dotenv(load_dotenv): </span><br><span class="line"></span><br><span class="line">cli.load_dotenv() </span><br><span class="line"></span><br><span class="line"><span class="comment"># if set, let env vars override previous values </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;FLASK_ENV&#x27;</span> <span class="keyword">in</span> os.environ: </span><br><span class="line"></span><br><span class="line">self.env = get_env() </span><br><span class="line"></span><br><span class="line">self.debug = get_debug_flag() </span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> <span class="string">&#x27;FLASK_DEBUG&#x27;</span> <span class="keyword">in</span> os.environ: </span><br><span class="line"></span><br><span class="line">self.debug = get_debug_flag() </span><br><span class="line"></span><br><span class="line"><span class="comment"># debug passed to method overrides all other sources </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">self.debug = <span class="built_in">bool</span>(debug) </span><br><span class="line"></span><br><span class="line">_host = <span class="string">&#x27;127.0.0.1&#x27;</span> </span><br><span class="line"></span><br><span class="line">_port = <span class="number">5000</span> </span><br><span class="line"></span><br><span class="line">server_name = self.config.get(<span class="string">&#x27;SERVER_NAME&#x27;</span>) </span><br><span class="line"></span><br><span class="line">sn_host, sn_port = <span class="literal">None</span>, <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> server_name: </span><br><span class="line"></span><br><span class="line">sn_host, _, sn_port = server_name.partition(<span class="string">&#x27;:&#x27;</span>) </span><br><span class="line"></span><br><span class="line">host = host <span class="keyword">or</span> sn_host <span class="keyword">or</span> _host </span><br><span class="line"></span><br><span class="line">port = <span class="built_in">int</span>(port <span class="keyword">or</span> sn_port <span class="keyword">or</span> _port) </span><br><span class="line"></span><br><span class="line">options.setdefault(<span class="string">&#x27;use_reloader&#x27;</span>, self.debug) </span><br><span class="line"></span><br><span class="line">options.setdefault(<span class="string">&#x27;use_debugger&#x27;</span>, self.debug) </span><br><span class="line"></span><br><span class="line">options.setdefault(<span class="string">&#x27;threaded&#x27;</span>, <span class="literal">True</span>) </span><br><span class="line"></span><br><span class="line">cli.show_server_banner(self.env, self.debug, self.name, <span class="literal">False</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">run_simple(host, port, self, **options) </span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>: </span><br><span class="line"></span><br><span class="line"><span class="comment"># reset the first request information if the development server </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># reset normally. This makes it possible to restart the server </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># without reloader and that stuff from an interactive shell. </span></span><br><span class="line"></span><br><span class="line">self._got_first_request = <span class="literal">False</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>启动 web 服务</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">run_simple(host, port, self, **options </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中<code>self</code>是<code>Flask</code>类的一个实例。 </p>
<p>执行函数内的<code>inner</code>函数，执行<code>make_server</code>函数 </p>
<ol start="2">
<li>执行 make_server 函数</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_server</span>(<span class="params">host=<span class="literal">None</span>, port=<span class="literal">None</span>, app=<span class="literal">None</span>, threaded=<span class="literal">False</span>, processes=<span class="number">1</span>, </span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">request_handler=<span class="literal">None</span>, passthrough_errors=<span class="literal">False</span>, </span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">ssl_context=<span class="literal">None</span>, fd=<span class="literal">None</span></span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Create a new server instance that is either threaded, or forks </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">or just processes one request after another. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> threaded <span class="keyword">and</span> processes &gt; <span class="number">1</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">raise</span> ValueError(<span class="string">&quot;cannot have a multithreaded and &quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;multi process server.&quot;</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> threaded: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ThreadedWSGIServer(host, port, app, request_handler, </span><br><span class="line"></span><br><span class="line">passthrough_errors, ssl_context, fd=fd) </span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> processes &gt; <span class="number">1</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ForkingWSGIServer(host, port, app, processes, request_handler, </span><br><span class="line"></span><br><span class="line">passthrough_errors, ssl_context, fd=fd) </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> BaseWSGIServer(host, port, app, request_handler, </span><br><span class="line"></span><br><span class="line">passthrough_errors, ssl_context, fd=fd) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="启动套接字"><a href="#启动套接字" class="headerlink" title="启动套接字"></a>启动套接字</h1><ol>
<li>执行 BaseWSGIServer</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, port, app, handler=<span class="literal">None</span>, </span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">passthrough_errors=<span class="literal">False</span>, ssl_context=<span class="literal">None</span>, fd=<span class="literal">None</span></span>): </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> handler <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">handler = WSGIRequestHandler </span><br><span class="line"></span><br><span class="line">self.address_family = select_ip_version(host, port) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> fd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">real_sock = socket.fromfd(fd, self.address_family, </span><br><span class="line"></span><br><span class="line">socket.SOCK_STREAM) </span><br><span class="line"></span><br><span class="line">port = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">HTTPServer.__init__(self, get_sockaddr(host, <span class="built_in">int</span>(port), </span><br><span class="line"></span><br><span class="line">self.address_family), handler) </span><br><span class="line"></span><br><span class="line">self.app = app </span><br><span class="line"></span><br><span class="line">self.passthrough_errors = passthrough_errors </span><br><span class="line"></span><br><span class="line">self.shutdown_signal = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line">self.host = host </span><br><span class="line"></span><br><span class="line">self.port = self.socket.getsockname()[<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line"><span class="comment"># Patch in the original socket. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> fd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">self.socket.close() </span><br><span class="line"></span><br><span class="line">self.socket = real_sock </span><br><span class="line"></span><br><span class="line">self.server_address = self.socket.getsockname() </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ssl_context <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(ssl_context, <span class="built_in">tuple</span>): </span><br><span class="line"></span><br><span class="line">ssl_context = load_ssl_context(*ssl_context) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ssl_context == <span class="string">&#x27;adhoc&#x27;</span>: </span><br><span class="line"></span><br><span class="line">ssl_context = generate_adhoc_ssl_context() </span><br><span class="line"></span><br><span class="line"><span class="comment"># If we are on Python 2 the return value from socket.fromfd </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># is an internal socket object but what we need for ssl wrap </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># is the wrapper around it :( </span></span><br><span class="line"></span><br><span class="line">sock = self.socket </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> PY2 <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(sock, socket.socket): </span><br><span class="line"></span><br><span class="line">sock = socket.socket(sock.family, sock.<span class="built_in">type</span>, sock.proto, sock) </span><br><span class="line"></span><br><span class="line">self.socket = ssl_context.wrap_socket(sock, server_side=<span class="literal">True</span>) </span><br><span class="line"></span><br><span class="line">self.ssl_context = ssl_context </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">self.ssl_context = <span class="literal">None</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在执行 init 方法时，会执行<code>HTTPServer.__init__</code>，因为HTTPServer 没有初始化方法，所以执行父类<code>TcpServer</code>的<code>init</code>，源码如下： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, server_address, RequestHandlerClass, bind_and_activate=<span class="literal">True</span></span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Constructor. May be extended, do not override.&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">BaseServer.__init__(self, server_address, RequestHandlerClass) </span><br><span class="line"></span><br><span class="line">self.socket = socket.socket(self.address_family, </span><br><span class="line"></span><br><span class="line">self.socket_type) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> bind_and_activate: </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">self.server_bind() </span><br><span class="line"></span><br><span class="line">self.server_activate() </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span>: </span><br><span class="line"></span><br><span class="line">self.server_close() </span><br><span class="line"></span><br><span class="line"><span class="keyword">raise</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这里就会绑定 ip 和端口并进行监听请求。 </p>
<ol start="2">
<li>监听请求，执行<code>TcpServer.server_activate()</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server_activate</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Called by constructor to activate the server. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">May be overridden. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">self.socket.listen(self.request_queue_size) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行 <code>self.socket.listen</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">listen</span>(<span class="params">self, backlog=<span class="literal">None</span></span>): <span class="comment"># real signature unknown; restored from __doc__ </span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">listen([backlog]) </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Enable a server to accept connections. If backlog is specified, it must be </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">at least 0 (if it is lower, it is set to 0); it specifies the number of </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">unaccepted connections that the system will allow before refusing new </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">connections. If not specified, a default reasonable value is chosen. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">pass</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看 cpython 的源码关于 socket 的，发现是用 c 写的，目前看不懂，记录如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> PyObject * </span><br><span class="line"></span><br><span class="line"><span class="title function_">sock_listen</span><span class="params">(PySocketSockObject *s, PyObject *args)</span> </span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line"></span><br><span class="line"><span class="comment">/* We try to choose a default backlog high enough to avoid connection drops </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* for common workloads, yet not too high to limit resource usage. */</span> </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> backlog = Py_MIN(SOMAXCONN, <span class="number">128</span>); </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> res; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!PyArg_ParseTuple(args, <span class="string">&quot;|i:listen&quot;</span>, &amp;backlog)) </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>; </span><br><span class="line"></span><br><span class="line">Py_BEGIN_ALLOW_THREADS </span><br><span class="line"></span><br><span class="line"><span class="comment">/* To avoid problems on systems that don&#x27;t allow a negative backlog </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* (which doesn&#x27;t make sense anyway) we force a minimum value of 0. */</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (backlog &lt; <span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">backlog = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">res = listen(s-&gt;sock_fd, backlog); </span><br><span class="line"></span><br><span class="line">Py_END_ALLOW_THREADS </span><br><span class="line"></span><br><span class="line"><span class="title function_">if</span> <span class="params">(res &lt; <span class="number">0</span>)</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s-&gt;<span class="title function_">errorhandler</span><span class="params">()</span>; </span><br><span class="line"></span><br><span class="line">Py_RETURN_NONE; </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="serve-forever"><a href="#serve-forever" class="headerlink" title="serve_forever"></a>serve_forever</h1><p>返回 <code>BaseServer</code>类对象给<code>srv</code>，执行该对象的<code>serve_forever</code>方法 </p>
<ol>
<li>执行serve_forever 方法</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_forever</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line">self.shutdown_signal = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">HTTPServer.serve_forever(self) </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt: </span><br><span class="line"></span><br><span class="line"><span class="keyword">pass</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>: </span><br><span class="line"></span><br><span class="line">self.server_close() </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里，已经把 flask 实例传进去了，在 <code>srv.app</code>就是 flask 实例，在<code>serve_foerever</code>里面是 self.app </p>
<ol start="2">
<li>执行 HTTPServer.serve_forever</li>
</ol>
<p>经过 <code>mro</code>查询， </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">graph TD </span><br><span class="line"></span><br><span class="line">A[HTTPServer] --&gt;|serve_forever| B(socketserver.TCPServer) </span><br><span class="line"></span><br><span class="line">B --&gt; C(BaseServer) </span><br><span class="line"></span><br><span class="line">C --&gt;D[BaseServer.serve_forever] </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最终执行的是<code>BaseServer.serve_forever</code>方法。 </p>
<ol start="3">
<li>执行 BaseServer.serve_forever</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_forever</span>(<span class="params">self, poll_interval=<span class="number">0.5</span></span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Handle one request at a time until shutdown. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Polls for shutdown every poll_interval seconds. Ignores </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">self.timeout. If you need to do periodic tasks, do them in </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">another thread. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">self.__is_shut_down.clear() </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">XXX:</span> Consider using another file descriptor or connecting to the </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># socket to wake this up instead of polling. Polling reduces our </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># responsiveness to a shutdown request and wastes cpu at all other </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># times. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> _ServerSelector() <span class="keyword">as</span> selector: </span><br><span class="line"></span><br><span class="line">selector.register(self, selectors.EVENT_READ) </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> self.__shutdown_request: </span><br><span class="line"></span><br><span class="line">ready = selector.select(poll_interval) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ready: </span><br><span class="line"></span><br><span class="line">self._handle_request_noblock() </span><br><span class="line"></span><br><span class="line">self.service_actions() </span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>: </span><br><span class="line"></span><br><span class="line">self.__shutdown_request = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line">self.__is_shut_down.<span class="built_in">set</span>() </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在调用该方法时，<code>HTTPSErver.serve_forever(self)</code>，这里的<code>self</code>是<code>BaseWSGIServer</code>对象，这个对象里面封装了<code>Flask</code>实例，也就是<code>self.app</code> </p>
<ol start="4">
<li>执行 self._handle_request_noblock()</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_handle_request_noblock</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Handle one request, without blocking. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">I assume that selector.select() has returned that the socket is </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">readable before this function was called, so there should be no risk of </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">blocking in get_request(). </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">request, client_address = self.get_request() </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> OSError: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.verify_request(request, client_address): </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">self.process_request(request, client_address) </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception: </span><br><span class="line"></span><br><span class="line">self.handle_error(request, client_address) </span><br><span class="line"></span><br><span class="line">self.shutdown_request(request) </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span>: </span><br><span class="line"></span><br><span class="line">self.shutdown_request(request) </span><br><span class="line"></span><br><span class="line"><span class="keyword">raise</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">self.shutdown_request(request) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>执行 self.get_request()</li>
</ol>
<p>根据 mro 查询，发现执行的是<code>BaseWSGIServer</code>的方法<code>get_reqeust</code> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_request</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line">con, info = self.socket.accept() </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> con, info </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>执行 self.socket.accept</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">accept</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;accept() -&gt; (socket object, address info) </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Wait for an incoming connection. Return a new socket </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">representing the connection, and the address of the client. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For IP sockets, the address info is a pair (hostaddr, port). </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">fd, addr = self._accept() </span><br><span class="line"></span><br><span class="line"><span class="comment"># If our type has the SOCK_NONBLOCK flag, we shouldn&#x27;t pass it onto the </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># new socket. We do not currently allow passing SOCK_NONBLOCK to </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># accept4, so the returned socket is always blocking. </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> = self.<span class="built_in">type</span> &amp; ~<span class="built_in">globals</span>().get(<span class="string">&quot;SOCK_NONBLOCK&quot;</span>, <span class="number">0</span>) </span><br><span class="line"></span><br><span class="line">sock = socket(self.family, <span class="built_in">type</span>, self.proto, fileno=fd) </span><br><span class="line"></span><br><span class="line"><span class="comment"># Issue #7995: if no default timeout is set and the listening </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># socket had a (non-zero) timeout, force the new socket in blocking </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mode to override platform-specific socket flags inheritance. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> getdefaulttimeout() <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> self.gettimeout(): </span><br><span class="line"></span><br><span class="line">sock.setblocking(<span class="literal">True</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sock, addr </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>执行 self._accept</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__getattribute__</span>(<span class="params">self, *args, **kwargs</span>): <span class="comment"># real signature unknown </span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot; Return getattr(self, name). &quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">pass</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="请求来时"><a href="#请求来时" class="headerlink" title="请求来时"></a>请求来时</h1><p>当一个请求来到 BaseWSGIServer服务器时，由<code>_accept</code>接收请求调用self.app，因为<code>Flask</code>里面定义了<code>__call__</code>方法，所以会执行该方法 </p>
<ol>
<li>执行<code>__call__</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, environ, start_response</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;The WSGI server calls the Flask application object as the </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">WSGI application. This calls :meth:`wsgi_app` which can be </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">wrapped to applying middleware.&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> self.wsgi_app(environ, start_response) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行 self.wsgi_app</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wsgi_app</span>(<span class="params">self, environ, start_response</span>): </span><br><span class="line"></span><br><span class="line">ctx = self.request_context(environ) </span><br><span class="line"></span><br><span class="line">error = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">ctx.push() </span><br><span class="line"></span><br><span class="line">response = self.full_dispatch_request() </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e: </span><br><span class="line"></span><br><span class="line">error = e </span><br><span class="line"></span><br><span class="line">response = self.handle_exception(e) </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span>: </span><br><span class="line"></span><br><span class="line">error = sys.exc_info()[<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line"><span class="keyword">raise</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response(environ, start_response) </span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.should_ignore_error(error): </span><br><span class="line"></span><br><span class="line">error = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line">ctx.auto_pop(error) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行 self.request_contest</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_context</span>(<span class="params">self, environ</span>): </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> RequestContext(self, environ) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该处的 <code>self</code>是<code>Flask</code>实例 </p>
<ol start="4">
<li>实例化 RequestContext 对象</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, app, environ, request=<span class="literal">None</span></span>): </span><br><span class="line"></span><br><span class="line">self.app = app </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> request <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">request = app.request_class(environ) </span><br><span class="line"></span><br><span class="line">self.request = request </span><br><span class="line"></span><br><span class="line">self.url_adapter = app.create_url_adapter(self.request) </span><br><span class="line"></span><br><span class="line">self.flashes = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line">self.session = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Request contexts can be pushed multiple times and interleaved with </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># other request contexts. Now only if the last level is popped we </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get rid of them. Additionally if an application context is missing </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># one is created implicitly so for each level we add this information </span></span><br><span class="line"></span><br><span class="line">self._implicit_app_ctx_stack = [] </span><br><span class="line"></span><br><span class="line"><span class="comment"># indicator if the context was preserved. Next time another context </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># is pushed the preserved context is popped. </span></span><br><span class="line"></span><br><span class="line">self.preserved = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># remembers the exception for pop if there is one in case the context </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># preservation kicks in. </span></span><br><span class="line"></span><br><span class="line">self._preserved_exc = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Functions that should be executed after the request on the response </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># object. These will be called before the regular &quot;after_request&quot; </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># functions. </span></span><br><span class="line"></span><br><span class="line">self._after_request_functions = [] </span><br><span class="line"></span><br><span class="line">self.match_request() </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>实例化 app.request_class(environ)</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, environ, populate_request=<span class="literal">True</span>, shallow=<span class="literal">False</span></span>): </span><br><span class="line"></span><br><span class="line">self.environ = environ </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> populate_request <span class="keyword">and</span> <span class="keyword">not</span> shallow: </span><br><span class="line"></span><br><span class="line">self.environ[<span class="string">&#x27;werkzeug.request&#x27;</span>] = self </span><br><span class="line"></span><br><span class="line">self.shallow = shallow </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实例化父类BaseRequest的<code>init</code>方法 </p>
<ol start="6">
<li>执行 ctx.push</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line">top = _request_ctx_stack.top </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> top.preserved: </span><br><span class="line"></span><br><span class="line">top.pop(top._preserved_exc) </span><br><span class="line"></span><br><span class="line"><span class="comment"># Before we push the request context we have to ensure that there </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># is an application context. </span></span><br><span class="line"></span><br><span class="line">app_ctx = _app_ctx_stack.top </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> app_ctx.app != self.app: </span><br><span class="line"></span><br><span class="line">app_ctx = self.app.app_context() </span><br><span class="line"></span><br><span class="line">app_ctx.push() </span><br><span class="line"></span><br><span class="line">self._implicit_app_ctx_stack.append(app_ctx) </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">self._implicit_app_ctx_stack.append(<span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(sys, <span class="string">&#x27;exc_clear&#x27;</span>): </span><br><span class="line"></span><br><span class="line">sys.exc_clear() </span><br><span class="line"></span><br><span class="line">_request_ctx_stack.push(self) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">session_interface = self.app.session_interface </span><br><span class="line"></span><br><span class="line">self.session = session_interface.open_session( </span><br><span class="line"></span><br><span class="line">self.app, self.request </span><br><span class="line"></span><br><span class="line">) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.session <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">self.session = session_interface.make_null_session(self.app) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行_app_ctx_stack.top </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@property </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">top</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;The topmost item on the stack. If the stack is empty, </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`None` is returned. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> self._local.stack[-<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> (AttributeError, IndexError): </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>执行 _request_ctx_stack.push(self)</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, obj</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Pushes a new item to the stack&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">rv = <span class="built_in">getattr</span>(self._local, <span class="string">&#x27;stack&#x27;</span>, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">self._local.stack = rv = [] </span><br><span class="line"></span><br><span class="line">rv.append(obj) </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> rv </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这一步将 RequestContext 对象放到_local 里面，对对象赋值调用对象的<code>setattr</code>方法 </p>
<ol start="8">
<li>执行 Local 的 setattr</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>): </span><br><span class="line"></span><br><span class="line">ident = self.__ident_func__() </span><br><span class="line"></span><br><span class="line">storage = self.__storage__ </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">storage[ident][name] = value </span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyError: </span><br><span class="line"></span><br><span class="line">storage[ident] = &#123;name: value&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>self.__storage__</code>是一个字典，类似于下面 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">storage = &#123; </span><br><span class="line"></span><br><span class="line">线程 <span class="built_in">id</span>: &#123;<span class="string">&#x27;stack&#x27;</span>: []&#125;, </span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="9">
<li>执行 RequestContext的 auto_pop 方法</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auto_pop</span>(<span class="params">self, exc</span>): </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> self.request.environ.get(<span class="string">&#x27;flask._preserve_context&#x27;</span>) <span class="keyword">or</span>  </span><br><span class="line"></span><br><span class="line">(exc <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.app.preserve_context_on_exception): </span><br><span class="line"></span><br><span class="line">self.preserved = <span class="literal">True</span> </span><br><span class="line"></span><br><span class="line">self._preserved_exc = exc </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line">self.pop(exc) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="10">
<li>执行是RequestContext 的 pop 方法</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self, exc=_sentinel</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Pops the request context and unbinds it by doing that. This will </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">also trigger the execution of functions registered by the </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">:meth:`~flask.Flask.teardown_request` decorator. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.. versionchanged:: 0.9 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Added the `exc` argument. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">app_ctx = self._implicit_app_ctx_stack.pop() </span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line">clear_request = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> self._implicit_app_ctx_stack: </span><br><span class="line"></span><br><span class="line">self.preserved = <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line">self._preserved_exc = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> exc <span class="keyword">is</span> _sentinel: </span><br><span class="line"></span><br><span class="line">exc = sys.exc_info()[<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line">self.app.do_teardown_request(exc) </span><br><span class="line"></span><br><span class="line"><span class="comment"># If this interpreter supports clearing the exception information </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># we do that now. This will only go into effect on Python 2.x, </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># on 3.x it disappears automatically at the end of the exception </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># stack. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(sys, <span class="string">&#x27;exc_clear&#x27;</span>): </span><br><span class="line"></span><br><span class="line">sys.exc_clear() </span><br><span class="line"></span><br><span class="line">request_close = <span class="built_in">getattr</span>(self.request, <span class="string">&#x27;close&#x27;</span>, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> request_close <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">request_close() </span><br><span class="line"></span><br><span class="line">clear_request = <span class="literal">True</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>: </span><br><span class="line"></span><br><span class="line">rv = _request_ctx_stack.pop() </span><br><span class="line"></span><br><span class="line"><span class="comment"># get rid of circular dependencies at the end of the request </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># so that we don&#x27;t require the GC to be active. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> clear_request: </span><br><span class="line"></span><br><span class="line">rv.request.environ[<span class="string">&#x27;werkzeug.request&#x27;</span>] = <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Get rid of the app as well if necessary. </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line">app_ctx.pop(exc) </span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> rv <span class="keyword">is</span> self, <span class="string">&#x27;Popped wrong request context. &#x27;</span>  </span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;(%r instead of %r)&#x27;</span> % (rv, self) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="11">
<li>执行 <code>_request_ctx_stack.pop()</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>): </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;Removes the topmost item from the stack, will return the </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">old value or `None` if the stack was already empty. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line">stack = <span class="built_in">getattr</span>(self._local, <span class="string">&#x27;stack&#x27;</span>, <span class="literal">None</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> stack <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">len</span>(stack) == <span class="number">1</span>: </span><br><span class="line"></span><br><span class="line">release_local(self._local) </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> stack[-<span class="number">1</span>] </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> stack.pop() </span><br><span class="line"></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://rsuxwvilc.github.io">vilc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://rsuxwvilc.github.io/2019/05/07/flask-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">https://rsuxwvilc.github.io/2019/05/07/flask-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/05/07/Web%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E3%80%81%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86%E5%92%8C%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/"><img class="prev-cover" src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Web身份验证、会话管理和访问控制</div></div></a></div><div class="next-post pull-right"><a href="/2019/05/03/Linux%E5%91%BD%E4%BB%A4%E6%A1%88%E4%BE%8B/"><img class="next-cover" src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Linux命令案例</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">vilc</div><div class="author-info__description">Linux Python Vim Git</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">141</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">39</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/rsuxwvilc"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/rsuxwvilc" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:shaozuanzuan@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-py-%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">启动 py 文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C-app-run-%E5%81%9A%E7%9A%84%E4%BA%8B"><span class="toc-number">2.</span> <span class="toc-text">执行 app.run()做的事</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">3.</span> <span class="toc-text">启动套接字</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#serve-forever"><span class="toc-number">4.</span> <span class="toc-text">serve_forever</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%9D%A5%E6%97%B6"><span class="toc-number">5.</span> <span class="toc-text">请求来时</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><div class="content"><a class="title" href="/2020/07/08/Sorting-HOW-TO/" title="Sorting HOW TO">Sorting HOW TO</a><time datetime="2020-07-08T09:40:07.000Z" title="Created 2020-07-08 17:40:07">2020-07-08</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2019/12/10/python-%E8%B0%83%E8%AF%95%E5%99%A8%E4%B9%8B-pdb/" title="python 调试器之 pdb">python 调试器之 pdb</a><time datetime="2019-12-10T05:50:16.000Z" title="Created 2019-12-10 13:50:16">2019-12-10</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-%E4%B8%80/" title="数据库（一）">数据库（一）</a><time datetime="2019-10-18T06:23:45.000Z" title="Created 2019-10-18 14:23:45">2019-10-18</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2019/10/18/hello-world/" title="Hello World">Hello World</a><time datetime="2019-10-18T06:23:43.000Z" title="Created 2019-10-18 14:23:43">2019-10-18</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2019/07/27/ubuntu-%E5%AE%89%E8%A3%85-Docker-CE/" title="ubuntu 安装 Docker CE">ubuntu 安装 Docker CE</a><time datetime="2019-07-27T08:13:19.000Z" title="Created 2019-07-27 16:13:19">2019-07-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By vilc</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>